<div style="text-align: center;">
  </divstyle>
  <img src="homebridge-melcloud-control.png" alt="Image" height="120" />
</div><br>

<div id="melCloudAccount" style="display: none;" class="card card-body">
  <form id="configForm">
    <div class="text-center">
      <label id="accountName" style="font-size: 23px">Account</label><br>
      <label id="info" style="text-align: center; font-size: 17px;"></label><br>
      <label id="info1" style="text-align: center; font-size: 15px;"></label><br>
      <label id="info2" style="text-align: center; font-size: 15px;"></label><br>
    </div>
    <div class="form-group">
      <label for="name">Name</label>
      <input id="name" type="text" class="form-control"><br>
      <label for="user">User Name</label>
      <input id="user" type="text" class="form-control"><br>
      <label for="passwd">Password</label>
      <input id="passwd" type="password" class="form-control"><br>
      <label for="language">Language</label>
      <select id="language" name="language" class="form-control"><br>
        <option value="0">English</option>
        <option value="1">Български</option>
        <option value="2">Čeština</option>
        <option value="3">Dansk</option>
        <option value="4">Deutsch</option>
        <option value="5">Eesti</option>
        <option value="6">Español</option>
        <option value="7">Français</option>
        <option value="8">Հայերեն</option>
        <option value="9">Latviešu</option>
        <option value="10">Lietuvių</option>
        <option value="11">Magyar</option>
        <option value="12">Nederlands</option>
        <option value="13">Norwegian</option>
        <option value="14">Polski</option>
        <option value="15">Português</option>
        <option value="16">Русский</option>
        <option value="17">Suomi</option>
        <option value="18">Svenska</option>
        <option value="19">Svenska</option>
        <option value="20">Українська</option>
        <option value="21">Türkçe</option>
        <option value="22">Ελληνικά</option>
        <option value="23">Hrvatski</option>
        <option value="24">Română</option>
        <option value="25">Slovenščina</option>
      </select><br>
    </div>
    <div class="text-center">
      <button id="logIn" type="button" class="btn btn-primary">Connect to MELCloud</button>
      <button id="configButton" type="button" class="btn btn-primary"><i class="fas fa-gear"></i></button>
    </div>
    <div id="accountButton">
    </div>
  </form>
</div>

<script>
  (async () => {
    //get the plugin config array
    const pluginConfig = await homebridge.getPluginConfig();

    if (!pluginConfig.length) {
      pluginConfig.push({});
      await homebridge.updatePluginConfig(pluginConfig);
      homebridge.showSchemaForm();
      return;
    }

    //get accounts count
    const accountsCount = pluginConfig[0].accounts.length;
    this.deviceIndex = 0;
    for (let i = 0; i < accountsCount; i++) {
      //create buttons
      const button = document.createElement("button");
      button.setAttribute("type", "button");
      button.setAttribute("id", `button${i}`);
      button.setAttribute("class", "btn btn-primary");
      button.style.textTransform = 'none';
      button.innerText = pluginConfig[0].accounts[i].name;
      document.getElementById("accountButton").appendChild(button);

      //get actuall value on account select
      document.getElementById(`button${i}`).addEventListener('click', async () => {
        for (let j = 0; j < accountsCount; j++) {
          const setRemoveAtribute = j === i ? document.getElementById(`button${j}`).setAttribute("class", "btn btn-secondary") : document.getElementById(`button${j}`).setAttribute("class", "btn btn-primary");
        }

        document.getElementById('accountName').innerHTML = pluginConfig[0].accounts[i].name || '';
        document.getElementById('name').value = pluginConfig[0].accounts[i].name || '';
        document.getElementById('user').value = pluginConfig[0].accounts[i].user || '';
        document.getElementById('passwd').value = pluginConfig[0].accounts[i].passwd || '';
        document.getElementById('language').value = pluginConfig[0].accounts[i].language || '';

        const accountConfigured = pluginConfig[0].accounts[i].name && pluginConfig[0].accounts[i].user && pluginConfig[0].accounts[i].passwd && pluginConfig[0].accounts[i].language;
        const button = document.getElementById('logIn');
        const setButtonState = accountConfigured ? button.disabled = false : button.disabled = true;

        await homebridge.updatePluginConfig(pluginConfig);
        this.deviceIndex = i;
      });
      const click = i === accountsCount - 1 ? document.getElementById(`button0`).click() : false;
      const update = i === accountsCount - 1 ? await homebridge.updatePluginConfig(pluginConfig) : false;
    };

    //load melCloudAccount form
    document.getElementById('melCloudAccount').style.display = 'block';

    //watch for changes to the form
    document.getElementById('configForm').addEventListener('input', async () => {
      pluginConfig[0].accounts[this.deviceIndex].name = document.querySelector('#name').value;
      pluginConfig[0].accounts[this.deviceIndex].user = document.querySelector('#user').value;
      pluginConfig[0].accounts[this.deviceIndex].passwd = document.querySelector('#passwd').value;
      pluginConfig[0].accounts[this.deviceIndex].language = document.querySelector('#language').value;

      const accountConfigured = pluginConfig[0].accounts[this.deviceIndex].name && pluginConfig[0].accounts[this.deviceIndex].user && pluginConfig[0].accounts[this.deviceIndex].passwd && pluginConfig[0].accounts[this.deviceIndex].language;
      const button = document.getElementById('logIn');
      const setButtonState = accountConfigured ? button.disabled = false : button.disabled = true;

      await homebridge.updatePluginConfig(pluginConfig);
      await homebridge.savePluginConfig(pluginConfig);
    });

    //watch for changes to the config button
    document.getElementById('configButton').addEventListener('click', async () => {
      const showHideSettings = this.configButtonState ? homebridge.hideSchemaForm() : homebridge.showSchemaForm();
      this.configButtonState = !this.configButtonState;
    });

    //watch for click on the login button
    document.getElementById('logIn').addEventListener('click', async () => {
      homebridge.showSpinner();
      document.getElementById('info').innerHTML = 'Connecting...';
      await homebridge.updatePluginConfig(pluginConfig)

      try {
        const accountName = pluginConfig[0].accounts[this.deviceIndex].name;
        const user = pluginConfig[0].accounts[this.deviceIndex].user;
        const passwd = pluginConfig[0].accounts[this.deviceIndex].passwd;
        const language = pluginConfig[0].accounts[this.deviceIndex].language;

        const payload = {
          accountName: accountName,
          user: user,
          passwd: passwd,
          language: language
        };
        const response = await homebridge.request('/connect', payload);
        const info = response.info ?? '';
        const status = response.status;
        const devices = response.data ?? [];
        const devicesByType = {
          ata: [],
          atw: [],
          erv: []
        };

        //new found devices
        const newDevices = {
          ata: [],
          ataPresets: [],
          atw: [],
          atwPresets: [],
          erv: [],
          ervPresets: [],
        };

        //info text
        let textAta = 'ATA: 0';
        let textAtaPresets = 'ATA Presets: 0';
        let textAtw = 'ATW: 0';
        let textAtwPresets = 'ATW Presets: 0';
        let textErv = 'ERV: 0';
        let textErvPresets = 'ERV Presets: 0';

        //response status
        switch (status) {
          case 0:
            //get devices by type
            for (const device of devices) {
              const deviceType = device.Type;
              const pusDeviceTypeAta = deviceType === 0 ? devicesByType.ata.push(device) : false;
              const pusDeviceTypeAtw = deviceType === 1 ? devicesByType.atw.push(device) : false;
              const pusDeviceTypeErv = deviceType === 3 ? devicesByType.erv.push(device) : false;
            };

            //get device info fom devices ata
            devicesByType.ata.forEach((device, index) => {
              const deviceId = device.DeviceID;
              const deviceType = device.Type;
              const deviceTypeText = "Air Conditioner";
              const deviceName = device.DeviceName;
              const devicePresets = device.Presets ?? [];

              //device ata
              const deviceAta = {
                id: deviceId,
                type: deviceType,
                typeString: deviceTypeText,
                name: deviceName,
                displayMode: 1,
                heatDryFanMode: 1,
                coolDryFanMode: 1,
                autoDryFanMode: 1,
                temperatureSensor: false,
                temperatureSensorOutdoor: false,
                presets: [],
                buttonsSensors: []
              };

              const ataDevicesExist = pluginConfig[0].accounts[this.deviceIndex].ataDevices ?? false;
              const ataDevices = ataDevicesExist ? pluginConfig[0].accounts[this.deviceIndex].ataDevices : pluginConfig[0].accounts[this.deviceIndex].ataDevices = [];
              const ataDeviceIdExist = ataDevices.some(device => device.id === deviceId);
              const pushTypeAta = ataDeviceIdExist ? false : ataDevices.push(deviceAta);
              const pushNewDevice = ataDeviceIdExist ? false : newDevices.ata.push(device);
              const devicesCount = newDevices.ata.length;
              textAta = `ATA: ${devicesCount}`

              //presets
              for (const preset of devicePresets) {
                const presetId = preset.ID;
                const presetName = preset.NumberDescription;

                preset.id = presetId;
                preset.name = presetName;
                preset.displayType == 0;
                preset.namePrefix = false;

                const ataPresetsExist = pluginConfig[0].accounts[this.deviceIndex].ataDevices[index].presets ?? false;
                const ataPresets = ataPresetsExist ? pluginConfig[0].accounts[this.deviceIndex].ataDevices[index].presets : pluginConfig[0].accounts[this.deviceIndex].ataDevices[index].presets = [];
                const ataPresetIdExist = ataPresets.some(preset => preset.id === presetId);
                const pushPresetAta = ataPresetIdExist ? false : ataPresets.push(preset);
                const pushNewPreset = ataPresetIdExist ? false : newDevices.ataPresets.push(preset);
                const presetsCount = newDevices.ataPresets.length;
                textAtaPresets = `ATA Presets: ${presetsCount}`
              };
            });

            //get device info fom devices atw
            devicesByType.atw.forEach((device, index) => {
              const deviceId = device.DeviceID;
              const deviceType = device.Type;
              const deviceTypeText = "Heat Pump";
              const deviceName = device.DeviceName;
              const devicePresets = device.Presets ?? [];

              //device atw
              const deviceAtw = {
                id: deviceId,
                type: deviceType,
                typeString: deviceTypeText,
                name: deviceName,
                displayMode: 1,
                temperatureSensor: false,
                temperatureSensorFlow: false,
                temperatureSensorReturn: false,
                temperatureSensorFlowZone1: false,
                temperatureSensorReturnZone1: false,
                temperatureSensorFlowWaterTank: false,
                temperatureSensorReturnWaterTank: false,
                temperatureSensorFlowZone2: false,
                temperatureSensorReturnZone2: false,
                temperatureSensor: false,
                temperatureSensorOutdoor: false,
                presets: [],
                buttonsSensors: []
              };
              const atwDevicesExist = pluginConfig[0].accounts[this.deviceIndex].atwDevices ?? false;
              const atwDevices = atwDevicesExist ? pluginConfig[0].accounts[this.deviceIndex].atwDevices : pluginConfig[0].accounts[this.deviceIndex].atwDevices = [];
              const atwDeviceIdExist = atwDevices.some(device => device.id === deviceId);
              const pushTypeAtw = atwDeviceIdExist ? false : atwDevices.push(deviceAtw);
              const pushNewDevice = atwDeviceIdExist ? false : newDevices.atw.push(device);
              const devicesCount = newDevices.atw.length;
              textAtw = `ATW: ${devicesCount}`

              //presetzs
              for (const preset of devicePresets) {
                const presetId = preset.ID;
                const presetName = preset.NumberDescription;

                preset.id = presetId;
                preset.name = presetName;
                preset.displayType == 0;
                preset.namePrefix = false;

                const atwPresetsExist = pluginConfig[0].accounts[this.deviceIndex].atwDevices[index].presets ?? false;
                const atwPresets = atwPresetsExist ? pluginConfig[0].accounts[this.deviceIndex].atwDevices[index].presets : pluginConfig[0].accounts[this.deviceIndex].atwDevices[index].presets = [];
                const atwPresetIdExist = atwPresets.some(preset => preset.id === presetId);
                const pushPresetAtw = atwPresetIdExist ? false : atwPresets.push(preset);
                const pushNewPreset = atwPresetIdExist ? false : newDevices.atwPresets.push(preset);
                const presetsCount = newDevices.atwPresets.length;
                textAtwPresets = `ATW Presets: ${presetsCount}`
              };
            });

            //get device info fom devices erv
            devicesByType.erv.forEach((device, index) => {
              const deviceId = device.DeviceID;
              const deviceType = device.Type;
              const deviceTypeText = "Energy Recovery Ventilation";
              const deviceName = device.DeviceName;
              const devicePresets = device.Presets ?? [];

              //device erv
              const deviceErv = {
                id: deviceId,
                type: deviceType,
                typeString: deviceTypeText,
                name: deviceName,
                displayMode: 1,
                temperatureSensor: false,
                temperatureSensorOutdoor: false,
                temperatureSensorSupply: false,
                temperatureSensor: false,
                temperatureSensorOutdoor: false,
                presets: [],
                buttonsSensors: []
              };
              const ervDevicesExist = pluginConfig[0].accounts[this.deviceIndex].ervDevices ?? false;
              const ervDevices = ervDevicesExist ? pluginConfig[0].accounts[this.deviceIndex].ervDevices : pluginConfig[0].accounts[this.deviceIndex].ervDevices = [];
              const ervDeviceIdExist = ervDevices.some(device => device.id === deviceId);
              const pushTypeerv = ervDeviceIdExist ? false : ervDevices.push(deviceErv);
              const pushNewDevice = ervDeviceIdExist ? false : newDevices.erv.push(device);
              const devicesCount = newDevices.erv.length;
              textErv = `ERV: ${devicesCount}`

              //presets
              for (const preset of devicePresets) {
                const presetId = preset.ID;
                const presetName = preset.NumberDescription;

                preset.id = presetId;
                preset.name = presetName;
                preset.displayType == 0;
                preset.namePrefix = false;

                const ervPresetsExist = pluginConfig[0].accounts[this.deviceIndex].ervDevices[index].presets ?? false;
                const ervPresets = ervPresetsExist ? pluginConfig[0].accounts[this.deviceIndex].ervDevices[index].presets : pluginConfig[0].accounts[this.deviceIndex].ervDevices[index].presets = [];
                const ervPresetIdExist = ervPresets.some(preset => preset.id === presetId);
                const pushPresetErv = ervPresetIdExist ? false : ervPresets.push(preset);
                const pushNewPreset = ervPresetIdExist ? false : newDevices.ervPresets.push(preset);
                const presetsCount = newDevices.ervPresets.length;
                textErvPresets = `ERV Presets: ${presetsCount}`
              };
            });

            const newDevicesCount = newDevices.ata.length + newDevices.atw.length + newDevices.erv.length ?? 0;
            const newPresetsCount = newDevices.ataPresets.length + newDevices.atwPresets.length + newDevices.ervPresets.length ?? 0;
            if (newDevicesCount === 0 && newPresetsCount === 0) {
              document.getElementById('info').innerHTML = 'No new devices found.';
              document.getElementById('info').style.color = 'white';
            };

            if (newDevicesCount > 0 && newPresetsCount > 0) {
              document.getElementById('info').innerHTML = `Found, ${textAta}, ${textAtw}, ${textErv}.`;
              document.getElementById('info').style.color = 'green';
              document.getElementById('info1').innerHTML = `${textAtaPresets}, ${textAtwPresets}, ${textErvPresets}.`;
              document.getElementById('info1').style.color = 'green';
              document.getElementById('info2').innerHTML = 'Now You can configure it.';
              document.getElementById('info2').style.color = 'green';
            };

            if (newDevicesCount > 0 && newPresetsCount === 0) {
              document.getElementById('info').innerHTML = `Found, ${textAta}, ${textAtw}, ${textErv}.`;
              document.getElementById('info').style.color = 'green';
              document.getElementById('info1').innerHTML = 'Now You can configure it.';
              document.getElementById('info1').style.color = 'green';
            };

            if (newDevicesCount === 0 && newPresetsCount > 0) {
              document.getElementById('info').innerHTML = `Found, ${textAtaPresets}, ${textAtwPresets}, ${textErvPresets}.`;
              document.getElementById('info').style.color = 'green';
              document.getElementById('info1').innerHTML = 'Now You can configure it.';
              document.getElementById('info1').style.color = 'green';
            }

            await homebridge.updatePluginConfig(pluginConfig);
            await homebridge.savePluginConfig(pluginConfig);
            break;
          case 1:
            document.getElementById('info').innerHTML = info;
            document.getElementById('info').style.color = 'red';
            break;
          default:
            document.getElementById('info').innerHTML = `Received unknown status: ${status}, please try again.`;
            document.getElementById('info').style.color = 'yellow';
            break;
        };

        homebridge.hideSpinner();
      } catch (e) {
        document.getElementById('info').innerHTML = 'Please try again.';
        homebridge.toast.error(`Data error: ${e.message}`);
      } finally {
        homebridge.hideSpinner();
      };
    });
  })();
</script>